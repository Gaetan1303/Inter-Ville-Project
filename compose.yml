services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "5000:5000"
    environment:
      - REDIS_URL=redis://redis:6379
      - NODE_ENV=test
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=cdpi_network
      - DB_USER=cdpi_network_user
      - DB_PASSWORD=cdpi_network_password
      - JWT_SECRET=production_secret_key
      - JWT_EXPIRE=1h
      - JWT_REFRESH_EXPIRE=7d
      - FRONTEND_URL=http://localhost:3000
      - SMTP_HOST=mailhog
      - SMTP_PORT=1025
      - SMTP_USER=
      - SMTP_PASSWORD=
      - EMAIL_FROM=production@laplateforme.io
      - MAX_FILE_SIZE=5242880
      - ALLOWED_FILE_TYPES=image/jpeg,image/png,image/jpg
      - ADMIN_EMAIL=admin@laplateforme.io
      - RATE_LIMIT_WINDOW_MS=900000
      - RATE_LIMIT_MAX_REQUESTS=100
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
      mailhog:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: '512M'

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    depends_on:
      - backend
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: '512M'

  redis:
    image: redis:latest
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: '256M'

  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025" # SMTP
      - "8025:8025" # Interface web
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: '128M'

  mysql:
    image: mysql:latest
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: cdpi_network
      MYSQL_USER: cdpi_network_user
      MYSQL_PASSWORD: cdpi_network_password
    volumes:
      - ./backend/database/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "root", "ping", "-p", "root"]
      interval: 20s
      timeout: 10s
      retries: 10
    deploy:
      resources:
        limits:
          cpus: '0.75'
          memory: '1G'

  jest:
    image: node:18
    working_dir: /app
    volumes:
      - ./backend:/app
    command: ["npm", "run", "test"]
    environment:
      - NODE_ENV=test
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=cdpi_network
      - DB_USER=cdpi_network_user
      - DB_PASSWORD=cdpi_network_password
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started

volumes:
  mysql_data: